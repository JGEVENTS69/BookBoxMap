<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte OpenStreetMap avec Clustering et Géolocalisation</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <style>
        #map {
            height: 100vh; /* La carte prendra toute la hauteur de la fenêtre */
            width: 100vw;  /* La carte prendra toute la largeur de la fenêtre */
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script>
        // Initialisation de la carte et définition de la vue
        var map = L.map('map').setView([46.6038236, 5.5142651], 6); // Coordonnées pour centrer la carte sur la France

        // Ajout des tuiles OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Créer un groupe de clusters
        var markers = L.markerClusterGroup();

        // Fonction pour charger les données JSON et ajouter des marqueurs
        fetch('libraries.json')
            .then(response => response.json())
            .then(data => {
                if (!Array.isArray(data)) {
                    throw new Error('Les données JSON doivent être un tableau.');
                }

                data.forEach(function(library) {
                    if (library.latitude && library.longitude && library.nom) {
                        var marker = L.marker([library.latitude, library.longitude]);
                        marker.bindPopup(`
                            <b>${library.nom}</b><br>
                            <img src="${library.imageUrl}" alt="${library.nom}" width="100" onerror="this.src='default-image.png';"><br>
                            ID: ${library.id}
                        `);
                        markers.addLayer(marker); // Ajouter le marqueur au groupe de clusters
                    } else {
                        console.warn('Données de bibliothèque incomplètes:', library);
                    }
                });

                map.addLayer(markers); // Ajouter le groupe de clusters à la carte
            })
            .catch(error => console.error('Erreur lors du chargement du fichier JSON:', error));

        // Créer un icône de marqueur orange pour la géolocalisation
        var orangeIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/JGEVENTS69/BookBoxMap/main/location-indicator-red-svgrepo-com.svg',
            iconSize: [30, 30], // Taille de l'icône
            iconAnchor: [15, 30], // Point d'ancrage pour le marqueur
            popupAnchor: [0, -30] // Position du popup par rapport au marqueur
        });

        // Fonction pour charger la géolocalisation
        function onLocationFound(e) {
            var radius = e.accuracy / 2;

            // Ajouter un marqueur pour la position de l'utilisateur avec l'icône orange
            L.marker(e.latlng, { icon: orangeIcon }).addTo(map)
                .bindPopup("Vous êtes ici !")
                .openPopup();

            // Ajouter un cercle pour la précision de la géolocalisation
            L.circle(e.latlng, radius).addTo(map);

            // Déplacer la carte vers la position de l'utilisateur
            map.setView(e.latlng, 13); // 13 est le niveau de zoom souhaité
        }

        function onLocationError(e) {
            alert(e.message);
        }

        // Demander la géolocalisation
        map.locate({ setView: true, maxZoom: 13 });

        // Événements de localisation
        map.on('locationfound', onLocationFound);
        map.on('locationerror', onLocationError);
    </script>
</body>
</html>
